# seabourne-wc-data-loaders

<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

### Table of Contents

-   [Introduction](#introduction)
-   [License](#license)
-   [Elements](#elements)
    -   [StreamedDataLoader](#streameddataloader)
        -   [Response format](#response-format)
        -   [Data processing function](#data-processing-function)
    -   [UpdatingStreamedDataLoader](#updatingstreameddataloader)
-   [Support Classes](#support-classes)
    -   [DeserializingDataProcessor](#deserializingdataprocessor)
        -   [Parameters](#parameters)
        -   [streamedDataProcessor](#streameddataprocessor)
    -   [PooledDataRequestMixin](#pooleddatarequestmixin)
        -   [Request activity state](#request-activity-state)
    -   [SharedEventSource](#sharedeventsource)
        -   [Parameters](#parameters-1)
        -   [addListener](#addlistener)
            -   [Parameters](#parameters-2)
        -   [removeListener](#removelistener)
            -   [Parameters](#parameters-3)
    -   [UpdatingDataLoaderMixin](#updatingdataloadermixin)
-   [name](#name)
-   [activityEvent](#activityevent)
-   [processor](#processor)
-   [url](#url)
-   [query](#query)
-   [state](#state)
-   [statusURL](#statusurl)

## Introduction

The Seabourne Data Loaders package provides Web Components for
loading data from a network source.


## License

[MIT](https://github.com/seabourne/seabourne-wc-data-loaders/blob/master/LICENSE)


## Elements

Two variants of streamed data loaders are provided:

-   `<streamed-data-loader>` - data is organized as a stream of
    Newline-Delimited JSON (NDJSON) objects
-   `<updating-streamed-data-loader>` - handles same data source
    as `<streamed-data-loader>`, updates data in response to
    change events


### StreamedDataLoader

**Extends PooledDataRequestMixin(LitElement)**

Streamed Data Loader Element.

This is organized as a "helper" element that handles the low-level
work of loading data from an AJAX data source.

It doesn't maintain any local reference to the loaded data (in part
because the data may be large). Instead, it passes loaded data to a
data processing function to transform or store it.

#### Response format

The response to the data request should consist of a sequence of
NDJSON-encoded objects:

-   header object - contains these properties:
    -   `count` **integer** - count of data objects
    -   `update` **boolean** - (optional) if true, data objects in
        response update previously loaded data; otherwise, the data
        objects replace previously loaded data in its entirety
    -   `timestamps` **object** - (optional) dependency timestamps
    -   `cutoff` **integer** - (optional) cutoff timestamp
-   data objects - zero or more data objects; each is coded as a
    two-element array containing these entries:
    -   key - object identifier
    -   object - the data object itself; `null` if the response is an
        update and the object has been deleted

If the data service cannot serve the request in a timely fashion
(such that there is a risk of the request timing out), it may return
a "retry" response containing only a header object, with no `count`
property. The loader detects this response and retries the request.

#### Data processing function

The loader is configured with a `processor` function to store or
otherwise transform the loaded data. It has the signature:
    processor(objects, header)

It is passed these parameters:

-   `objects` **ReadableStream** - a stream that returns the loaded
    data objects; each object is a two-element array containing the
    object identifier and the object itself (that is, the decoded
    NDJSON rows from the response)
-   `header` **Object** - the decoded header object from the response

### UpdatingStreamedDataLoader

**Extends StreamedDataLoader, UpdatingDataLoaderMixin**

Updating Streamed Data Loader Element.
Extends `StreamedDataLoader` with `UpdatingDataLoaderMixin` to
provide a streamed data loader that responds to change events.

## Support Classes

The package also includes a handful of support classes. The
`SharedEventSource` class allows sharing of `EventSource`
instances among multiple listeners. The `PooledDataRequestMixin`
provides queueing of `fetch()` requests so as to limit the
number of concurrently active requests. The
`UpdatingDataLoaderMixin` triggers updates when data changes.
The `DeserializingDataProcessor` is a processor for loading of
serialized data entities.


### DeserializingDataProcessor

Data processor for handling serialized entities.
Provides data processing functions for entity data loading and
editing elements. (Such as `<streamed-data-loader>`.)

The processing function deserializes incoming entities and transfers
them to storage. Storage is an associative array (called a _bucket_,
for want of a better term), defined as a property of a container
object.

Updating of the bucket is designed to "play nice" with code that
responds to changes in the bucket and its contents (various Web
Components). An incoming entity won't replace an existing stored
entity if the two are equal (the existing object is preserved for
the benefit of code that detects changes through object equality).
If data loading results in changes, the bucket is copied (again,
for code that checks object equality).

If the bucket is undefined when the processing function is invoked,
it is created (it will be empty if no data was loaded).

A note on entity keys: Data loaders deliver data entities along
with an identifying key for each entity. Depending on the loader,
the key may have a prefix that should be removed by the processor.
If the processor is configured with a `keyPrefix` option, incoming
keys are expected to have the form `<key-prefix>.<key>`, and the
prefix and separator are discarded.

When the data processing function removes an existing data
entity from the element property (because it is replacing the
entity or replacing the element property in its entirety), it
invokes the entity's `destroy()` method, if one is defined.

#### Parameters

-   `container` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** container element; the _bucket_ where
      incoming entities are stored is a property of the container
-   `property` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** name of the container bucket property
-   `options` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** data processing options:-   `serialization` (`Object`) - entity serialization object;
          provides a `wrapEntity(entity, context)` method for
          deserializing incoming entities
    -   `keyPrefix` (`String`) - key prefix for data entities; default
          is the `property` parameter

#### streamedDataProcessor

Data processing function for a stream of data entities.

Loaded data entities are delivered by a `ReadableStream` that
supplies a sequence of two-element arrays comprised of the entity
key and the entity itself.

The data processing function takes these parameters:

-   `entities` **ReadableStream** - the data entity stream 
-   `header` **Object** - header object; properties:
    -   `update` - if true, update the storage bucket; otherwise,
        replace its content in its entirety

Returns **[Function](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function)** data processor

### PooledDataRequestMixin

Data request mixin.

Coded as a mixin so that it can use the element context to dispatch
activity events. This also means it defers data requests until the
element is connected and cancels any active requests when
disconnected.

#### Request activity state

The mixin tracks request activity state. The state is updated when
the data request is queued for processing, when it becomes active,
and when it is released on completion. Client code may report other
state changes, such as intermediate activity states, using the
`updateDataRequestActivity()` method.

If configured with an `activityEvent`, the mixin will emit events to
indicate changes in activity state. The event type is specified by
`activityEvent`; the event `detail` property contains a `name`
subproperty set from the mixin `name`, and an `activity` subproperty
that indicates activity state. Client code may supply additional
subproperties.

### SharedEventSource

Shared EventSource objects.

#### Parameters

-   `url`  
-   `options`  

#### addListener

Adds event listener, disallowing multiple listeners.

##### Parameters

-   `event` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** event name
-   `listener` **[Function](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function)** event listener

#### removeListener

Removes event listener.

##### Parameters

-   `event` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** event name
-   `listener` **[Function](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function)** event listener

### UpdatingDataLoaderMixin

Updating data loader mixin.
Listens to an `EventSource` for status events that indicate changes
to the data loader's data source and triggers a data request when
changes occur.

It is configured with the URL of the status event source and the
status event name. Conventionally, these are derived from the URL of
the data loader's data source â€“ the status URL formed from a stem of
the data URL (presumably a root path of a data API) with `/status`
appended; the status name taken from the pathname of the data URL,
possibly with a distinguishing identifier appended.

For example, a data source URL `https://data.site.org/api/entities`
might produce:

-   `https://data.site.org/api/status` - status event source URL
-   `/api/entities` - status event name
-   `/api/entities:5dcb3cb3b427b70043dfb9bb` - status event name with
    a qualifying identifier

## name

Data request name (for display purposes).

## activityEvent

Event for reporting data request activity.
The event `detail` will contain `name` and `status` properties.

## processor

Data processor.

## url

URL of data source.

## query

Query parameters for data request.

## state

Data unloaded/error state.

## statusURL

URL of status EventSource.
