# nxus-data-loaders

<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

### Table of Contents

-   [Introduction](#introduction)
-   [Elements](#elements)
    -   [StreamedDataLoader](#streameddataloader)
        -   -   -   [Response format](#response-format)
                -   [Data processing function](#data-processing-function)
    -   [UpdatingStreamedDataLoader](#updatingstreameddataloader)
-   [Support Classes](#support-classes)
    -   [PooledDataRequestMixin](#pooleddatarequestmixin)
    -   [SharedEventSource](#sharedeventsource)
        -   [Parameters](#parameters)
        -   [addListener](#addlistener)
            -   [Parameters](#parameters-1)
        -   [removeListener](#removelistener)
            -   [Parameters](#parameters-2)
    -   [UpdatingDataLoaderMixin](#updatingdataloadermixin)
-   [processor](#processor)
-   [url](#url)
-   [query](#query)
-   [name](#name)
-   [activityEvent](#activityevent)
-   [state](#state)
-   [statusURL](#statusurl)

## Introduction

The Nxus Data Loaders package provides Web Components for
loading data from a network source.


## Elements

Two variants of streamed data loaders are provided:

-   `<streamed-data-loader>` - data is organized as a stream of
    Newline-Delimited JSON (NDJSON) objects
-   `<updating-streamed-data-loader>` - handles same data source
    as `<streamed-data-loader>`,  updates data in response to
    change events


### StreamedDataLoader

**Extends PooledDataRequestMixin(LitElement)**

Streamed Data Loader.

This is organized as a "helper" element that handles the low-level
work of loading data from an AJAX data source.

It doesn't maintain any local reference to the loaded data (in part
because the data may be large). Instead, it passes loaded data to a
data processing function to transform or store it.

For the simple use case, the loader can perform a one-time loading of
data. However,  it can also be configured to listen to `EventSource`
events that indicate changes to the data, and to load updated data
when changes occur.

###### Response format

The response to the data request consists of a sequence of
NDJSON-encoded objects:

-   header object - contains these properties:
    -   `count` **integer** - count of data objects
    -   `update` **boolean** - (optional) if true, data objects in
        response update previously loaded data; otherwise, the data
        objects replace previously loaded data in its entirety
    -   `timestamps` **object** - (optional) dependency timestamps
    -   `cutoff` **integer** - (optional) cutoff timestamp
-   data objects - zero or more data objects; each is coded as a
    two-element array containing these entries:
    -   key - object identifier
    -   object - the data object itself; `null` if the response is an
        update and the object has been deleted

###### Data processing function

The loader is configured with a `processor` function to store or
otherwise transform the loaded data. It has the signature:

    ```
    processor(objects, update)
    ```

It is passed these parameters:

-   `objects` **object** - an associative array containing the
    loaded data objects; keys are assigned from the key entry of the
    response data; deleted object have an `undefined` value
-   `update` **boolean** - `true` if the data is an update.

### UpdatingStreamedDataLoader

**Extends StreamedDataLoader, UpdatingDataLoaderMixin**

Updating Streamed Data Loader.
Extends `StreamedDataLoader` with `UpdatingDataLoaderMixin` to
provide a streamed data loader that responds to change events.

## Support Classes

The package also includes a handful of support classes. The
`SharedEventSource` class allows sharing of `EventSource`
instances among multiple listeners. The `PooledDataRequestMixin`
provides queueing of `fetch()` requests so as to limit the
number of concurrently active requests. The
`UpdatingDataLoaderMixin` triggers updates when data changes.


### PooledDataRequestMixin

Data request mixin.

Coded as a mixin so that it can use the element context to dispatch
activity events. This also means it defers data requests until the
element is connected and cancels any active requests when
disconnected.

### SharedEventSource

Shared EventSource objects.

#### Parameters

-   `url`  
-   `options`  

#### addListener

Adds event listener, disallowing multiple listeners.

##### Parameters

-   `event` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** event name
-   `listener` **[Function](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function)** event listener

#### removeListener

Removes event listener.

##### Parameters

-   `event` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** event name
-   `listener` **[Function](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function)** event listener

### UpdatingDataLoaderMixin

Updating data loader mixin.
Listens to an `EventSource` for status events that indicate changes
to the data loader's data source and triggers a data request when
changes occur.

It is configured with the URL of the status event source and the
status event name. Conventionally, these are derived from the URL of
the data loader's data source â€“ the status URL formed from a stem of
the data URL (presumably a root path of a data API) with `/status`
appended; the status name taken from the pathname of the data URL,
possibly with a distinguishing identifier appended.

For example, a data source URL `https://data.site.org/api/entities`
might produce:

-   `https://data.site.org/api/status` - status event source URL
-   `/api/entities` - status event name
-   `/api/entities:5dcb3cb3b427b70043dfb9bb` - status event name with
    a qualifying identifier

## processor

Data processor.

## url

URL of data source.

## query

Query parameters for data request.

## name

Data request name (for display purposes).

## activityEvent

Event for reporting data request activity.
The event `detail` will contain `name` and `status` properties.

## state

Data unloaded/error state.

## statusURL

URL of status EventSource.
